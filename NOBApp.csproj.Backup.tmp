<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
		<OutputType>WinExe</OutputType>
		<TargetFramework>net6.0-windows</TargetFramework>
		<Nullable>enable</Nullable>
		<UseWPF>true</UseWPF>
		<StartupObject>NOBApp.App</StartupObject>
		<UseWindowsForms>True</UseWindowsForms>
		<ApplicationManifest>app.manifest</ApplicationManifest>
		<Platforms>x86</Platforms>
		<PackageIcon>SteamPGIN.png</PackageIcon>
		<AllowUnsafeBlocks>true</AllowUnsafeBlocks>
		<ImplicitUsings>disable</ImplicitUsings>
		<BaseOutputPath>C:\BOT</BaseOutputPath>
	</PropertyGroup>
	
	<ItemGroup>
		<None Remove="448545149_994763355983896_6737183326767466195_n.jpg" />
		<None Remove="6f90a860dd47c4bafb631f2fa7930e50.png" />
		<None Remove="images.jpg" />
		<None Remove="support_me_on_kofi_badge_dark.png" />
		<None Remove="support_me_on_kofi_dark.png" />
	</ItemGroup>

	<ItemGroup>
		<COMReference Include="dm">
			<VersionMinor>0</VersionMinor>
			<VersionMajor>1</VersionMajor>
			<Guid>84288aad-ba02-4ef2-85ec-3fad4d11354d</Guid>
			<Lcid>0</Lcid>
			<WrapperTool>tlbimp</WrapperTool>
			<Isolated>false</Isolated>
			<EmbedInteropTypes>true</EmbedInteropTypes>
		</COMReference>
	</ItemGroup>

	<ItemGroup>
		<None Include="..\.editorconfig" Link=".editorconfig" />
		<None Include="Stea.png">
			<Pack>True</Pack>
			<PackagePath>\</PackagePath>
		</None>
	</ItemGroup>

	<ItemGroup>
		<PackageReference Include="Google.Apis.Sheets.v4" Version="1.68.0.3624" />
		<PackageReference Include="MSBuildTasks" Version="1.5.0.235">
			<PrivateAssets>all</PrivateAssets>
			<IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
		</PackageReference>
		<PackageReference Include="System.Management" Version="8.0.0" />
	</ItemGroup>

	<ItemGroup>
		<Resource Include="448545149_994763355983896_6737183326767466195_n.jpg" />
		<Resource Include="6f90a860dd47c4bafb631f2fa7930e50.png" />
		<Resource Include="images.jpg" />
		<Resource Include="support_me_on_kofi_dark.png">
			<CopyToOutputDirectory>Never</CopyToOutputDirectory>
		</Resource>
	</ItemGroup>

	<ItemGroup>
		<Compile Update="Properties\Resources.Designer.cs">
			<DesignTime>True</DesignTime>
			<AutoGen>True</AutoGen>
			<DependentUpon>Resources.resx</DependentUpon>
		</Compile>
		<Compile Update="Properties\Settings.Designer.cs">
			<DesignTimeSharedInput>True</DesignTimeSharedInput>
			<AutoGen>True</AutoGen>
			<DependentUpon>Settings.settings</DependentUpon>
		</Compile>
	</ItemGroup>

	<ItemGroup>
		<EmbeddedResource Update="Properties\Resources.resx">
			<Generator>ResXFileCodeGenerator</Generator>
			<LastGenOutput>Resources.Designer.cs</LastGenOutput>
		</EmbeddedResource>
	</ItemGroup>

	<ItemGroup>
		<None Update="GoogleData\client_secrets2.json">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>
		<None Update="libs\Bkgnd.dll">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>
		<None Update="libs\dm.dll">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>
		<None Update="libs\DmReg.dll">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>
		<None Update="libs\handle.exe">
			<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
		</None>
		<None Update="Properties\Settings.settings">
			<Generator>SettingsSingleFileGenerator</Generator>
			<LastGenOutput>Settings.Designer.cs</LastGenOutput>
		</None>
	</ItemGroup>

	<Target Name="CustomActionsBeforebuild" BeforeTargets="build">
		<Message Text="BeforePublish 開始執行" Importance="high" />
		<Exec Command="powershell -NoProfile -ExecutionPolicy Bypass -File UpdateVersion.ps1" />
		<Message Text="BeforePublish 執行完畢" Importance="high" />
	</Target>

	<Target Name="CustomActionsAfterPublish" AfterTargets="Publish">
		<Message Text="AfterTargets 開始執行" Importance="high" />
		<ReadLinesFromFile File="$(MSBuildProjectDirectory)\VersionInfo.cs">
			<Output TaskParameter="Lines" ItemName="VersionFileLines" />
		</ReadLinesFromFile>

		<PropertyGroup>
			<!-- 將所有行合併為一個字串 -->
			<VersionFileContent>@(VersionFileLines, ' ')</VersionFileContent>
			<!-- 使用正則表達式提取版本號 -->
			<VersionNumber>$([System.Text.RegularExpressions.Regex]::Match('$(VersionFileContent)', 'public\s+const\s+string\s+Version\s*=\s*"([^"]+)"').Groups[1].Value)</VersionNumber>
		</PropertyGroup>

		<PropertyGroup>
			<!-- 使用正則表達式從文件中提取版本號 -->
			<VersionNumber>$([System.Text.RegularExpressions.Regex]::Match('$(VersionFileContent)', 'Version\s*=\s*"([^"]+)"').Groups[1].Value)</VersionNumber>
		</PropertyGroup>
		<!-- 調試輸出 -->
		<Message Importance="High" Text="版號資料夾: $(VersionFileContent)" />
		<Message Importance="High" Text="版號: $(VersionNumber)" />
		
		<PropertyGroup>
			<OutputDir>$(PublishDir)</OutputDir>
			<ZipFilePath>C:\NOBAPP\企鵝之野望$(VersionNumber).zip</ZipFilePath>
			<SevenZipPath>"C:\Program Files\7-Zip\7z.exe"</SevenZipPath>
		</PropertyGroup>
		<Message Importance="High" Text="版號 : $(VersionNumber)" />
		<Message Importance="High" Text="輸出資料夾 (PublishDir): $(OutputDir)" />

		<!-- 刪除舊的壓縮檔案 -->
		<ItemGroup>
			<OldZipFiles Include="$(PublishDir)企鵝之野望*.zip" />
		</ItemGroup>
		<Delete Files="@(OldZipFiles)" />

		<!-- 確保所有檔案已釋放 -->
		<Exec Command="powershell -NoProfile -ExecutionPolicy Bypass -File &quot;$(MSBuildProjectDirectory)\CheckFileLock.ps1&quot; -FilePath &quot;$(OutputDir)NOBApp.exe&quot; -MaxRetries 5 -DelaySeconds 2" />

		<!-- 使用 7-Zip 壓縮發佈目錄 -->
		<Exec Command="$(SevenZipPath) a -tzip &quot;$(ZipFilePath)&quot; &quot;$(OutputDir)*&quot;" />
	</Target>

	<Target Name="PreBuild" BeforeTargets="PreBuildEvent">
	  <Exec Command="powershell -NoProfile -ExecutionPolicy Bypass -File UpdateVersion.ps1" />
	</Target>

</Project>